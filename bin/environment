# vim: ft=sh
#Set up what we expect to have a good superforker environment. This is used from
#start and stop before the first fork
DIR=$(python -c "import os; print os.path.dirname(os.path.realpath(\"${0}\"))")

#use the node we insist on
export NVM_DIR=""
source "${DIR}/nvm/nvm.sh"
NEEDED_NODE_VERSION='v0.10.3'
HAS_NEEDED_VERSION=`nvm ls | grep ${NEEDED_NODE_VERSION}`

if [ -z "${HAS_NEEDED_VERSION}" ]; then
  echo 'get the right version of node going'
  nvm install $NEEDED_NODE_VERSION
  npm update
fi

nvm use $NEEDED_NODE_VERSION
which node
HAS_FOREVER=`which forever`
if [ -z "${HAS_FOREVER}" ]; then
  npm install -g forever
fi
export BIN=${DIR}
export APP=${DIR}/..
export ROOT=${HOME}/.superforker
mkdir ${ROOT}
export LOG_DIR=${ROOT}/var/log
export ETC_DIR=${ROOT}/etc
export FORKER_SHA=`git log -1 --oneline | awk '{ print $1 }'`
export PORT=8080
export HANDLE_THIS=${ROOT}
export HANDLE_THIS=${ETC_DIR}/handlers

#source any included environment if present
if [ -e ${ROOT}/etc/environment/environment ]; then
  source ${ROOT}/etc/environment/environment
	pushd ${ROOT}/etc/environment
	export ENVIRONMENT_SHA=`git log -1 --oneline | awk '{ print $1 }'`
	popd
fi
