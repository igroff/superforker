#!/usr/bin/env bash
# vim: ft=sh
source "${SUPERFORKER_ROOT}/src/env"
RUNNING=`forever list | grep  "${SUPERFORKER_INSTALLED}"`
if [ -z "${RUNNING}" ]; then
  forever start --append -l ${LOG_DIR}/forever.log -o ${LOG_DIR}/out.log -e ${LOG_DIR}/err.log --watch --watchDirectory "${SUPERFORKER_INSTALLED}" "${SUPERFORKER_INSTALLED}/src/server_shim.js" ${PORT} ${HANDLE_THIS}
fi
#and put in a watchdog cron task to keep everything working
WATCHDOG=`crontab -l | grep "${ROOT}"`
if [ -z "${WATCHDOG}" ]; then
  echo "Adding a watchdog"
  crontab -l > crontemp
  printf "* * * * *\texport ROOT=\"${ROOT}\"; export SUPERFORKER_ROOT=\"${SUPERFORKER_ROOT}\"; source \"${SUPERFORKER_ROOT}/src/bootstrap\" > /dev/null 2>&1; superforker watchdog > \"${LOG_DIR}/watchdog.log\" 2>&1\n" >> crontemp
  cat crontemp | crontab
  rm crontemp
fi
