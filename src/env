# vim: ft=sh
#Set up what we expect to have a good superforker environment. This is used from
#start and stop before the first fork

#first, make sure we have boostrapped node
source "${SUPERFORKER_ROOT}/src/bootstrap"

export BIN="${SUPERFORKER_ROOT}/bin"

#now all our environment variables
export ETC_DIR="${ROOT}/etc"
if [ ! -d "${ETC_DIR}" ]; then
    mkdir -p "${ETC_DIR}"
fi
export LOG_DIR="${ROOT}/var/log"
if [ ! -d "${LOG_DIR}" ]; then
    mkdir -p "${LOG_DIR}"
fi
export FORKER_SHA=`git log -1 --oneline | awk '{ print $1 }'`
export PORT=8080
export HANDLE_THIS=${ETC_DIR}/handlers

if [ ! -d "${ROOT}/${NEEDED_NODE_VERSION}/lib/node_modules/superforker" ]; then
  npm install -g "${SUPERFORKER_ROOT}"
  npm install -g forever
fi

#source any included environment if present
if [ -d "${ETC_DIR}/environment" ]; then
  if [ -e "${ETC_DIR}/environment/environment" ]; then
    source "${ETC_DIR}/environment/environment"
  fi
	pushd "${ETC_DIR}/environment" > /dev/null
	export ENVIRONMENT_SHA=`git log -1 --oneline | awk '{ print $1 }'`
	popd > /dev/null
fi
#and any handlers if present
if [ -d "${ETC_DIR}/handlers" ]; then
	pushd "${ETC_DIR}/handlers" > /dev/null
	export HANDLERS_SHA=`git log -1 --oneline | awk '{ print $1 }'`
	popd > /dev/null
fi

echo Here is what will run
which node
which superforker
which forever
